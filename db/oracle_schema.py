from .oracle_init import get_db_connection

def create_oracle_tables():
    """
    Oracle DBì— í•„ìš”í•œ í…Œì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤.
    í…Œì´ë¸”ëª…: DEPOSIT
    id: ì•„ì´ë””
    account_holder: ì˜ˆê¸ˆì£¼
    balance: ì”ì•¡
    í…Œì´ë¸”ëª…: LOAN
    id: ì•„ì´ë””
    borrower: ëŒ€ì¶œì
    money: ëŒ€ì¶œê¸ˆ
    """

    conn = get_db_connection()
    cursor = conn.cursor()

    try:
        # deposit í…Œì´ë¸” ìƒì„±
        cursor.execute("""
            SELECT table_name
            FROM user_tables
            WHERE table_name = 'DEPOSIT'
        """)

        result = cursor.fetchone()
        if result:
            print("ğŸ‰ oracle_schema >> 'deposit' í…Œì´ë¸”ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.")
        else:   
            cursor.execute("""
                CREATE TABLE deposit (
                    id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
                    account_holder VARCHAR2(100) NOT NULL,
                    balance NUMBER DEFAULT 0 NOT NULL 
                )
            """)
            
            print("ğŸ‰ oracle_schema >> 'deposit' í…Œì´ë¸” ìƒì„± ì„±ê³µ.")

        # loan í…Œì´ë¸” ìƒì„±
        cursor.execute("""
            SELECT table_name
            FROM user_tables
            WHERE table_name = 'LOAN'
        """)

        result = cursor.fetchone()
        if result:
            print("ğŸ‰ oracle_schema >> 'loan' í…Œì´ë¸”ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.")
        else:
            cursor.execute("""
                CREATE TABLE loan (
                    id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
                    borrower VARCHAR2(100) NOT NULL,
                    money NUMBER DEFAULT 0 NOT NULL 
                )
            """)
            
            print("ğŸ‰ oracle_schema >> 'loan' í…Œì´ë¸” ìƒì„± ì„±ê³µ.")
            
    except Exception as e:
        print(f"âŒ oracle_schema >> í…Œì´ë¸” ìƒì„± ì—ëŸ¬: {e}")

    finally:
        cursor.close()
        conn.close()

def insert_deposit(account_holder: str, balance: int):
    """
    Oracle DBì— ì˜ˆì‹œ ë°ì´í„°ë¥¼ ì‚½ì…í•©ë‹ˆë‹¤.
    DEPOSIT í…Œì´ë¸”ì— ì˜ˆê¸ˆì£¼ê°€ ì¤‘ë³µë˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ë°ì´í„°ë¥¼ ì‚½ì…í•©ë‹ˆë‹¤.
    """

    conn = get_db_connection()
    cursor = conn.cursor()

    try:
        cursor.execute("""
            SELECT id 
            FROM deposit 
            WHERE account_holder = :account_holder
            """, account_holder=account_holder
        )

        result = cursor.fetchone()
        if result:
            print(f"ğŸ‰ oracle_schema >> í•´ë‹¹ ì˜ˆê¸ˆì£¼ì˜ ë°ì´í„° ì´ë¯¸ ì¡´ì¬: {result[0]}")
            return
        
        cursor.execute("""
            INSERT INTO deposit (account_holder, balance)
            VALUES (:account_holder, :balance)
            """, account_holder=account_holder, balance=balance
        )

        conn.commit()
        print(f"ğŸ‰ oracle_schema >> ë°ì´í„° ì‚½ì… ì„±ê³µ: {account_holder}, {balance}")

    except Exception as e:
        print(f"âŒ oracle_schema >> ë°ì´í„° ì¡°íšŒ ì—ëŸ¬: {e}")

    finally:
        cursor.close()
        conn.close()

def insert_loan(borrower: str, money: int):
    """
    Oracle DBì— ì˜ˆì‹œ ë°ì´í„°ë¥¼ ì‚½ì…í•©ë‹ˆë‹¤.
    LOAN í…Œì´ë¸”ì— ëŒ€ì¶œìê°€ ì¤‘ë³µë˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ë°ì´í„°ë¥¼ ì‚½ì…í•©ë‹ˆë‹¤.
    """

    conn = get_db_connection()
    cursor = conn.cursor()

    try:
        cursor.execute("""
            SELECT id 
            FROM loan 
            WHERE borrower = :borrower
            """, borrower=borrower
        )

        result = cursor.fetchone()
        if result:
            print(f"ğŸ‰ oracle_schema >> í•´ë‹¹ ëŒ€ì¶œìì˜ ë°ì´í„° ì´ë¯¸ ì¡´ì¬: {result[0]}")
            return
        
        cursor.execute("""
            INSERT INTO loan (borrower, money)
            VALUES (:borrower, :money)
            """, borrower=borrower, money=money
        )

        conn.commit()
        print(f"ğŸ‰ oracle_schema >> ë°ì´í„° ì‚½ì… ì„±ê³µ: {borrower}, {money}")

    except Exception as e:
        print(f"âŒ oracle_schema >> ë°ì´í„° ì¡°íšŒ ì—ëŸ¬: {e}")

    finally:
        cursor.close()
        conn.close()